name: ğŸš— RÃ©cupÃ©ration DATEX II DIR Ouest

on:
  # Automatique toutes les 15 minutes
  schedule:
    - cron: '*/15 * * * *'
  
  # Manuel aussi (bouton dans GitHub)
  workflow_dispatch:
  
  # Ã€ chaque push sur main (pour tester)
  push:
    branches: [ main ]

jobs:
  fetch-datex:
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ“¥ Checkout du repo
      uses: actions/checkout@v4
      
    - name: ğŸ Setup Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
    
    - name: ğŸ“¦ Installer dÃ©pendances
      run: |
        pip install requests lxml
    
    - name: ğŸš— RÃ©cupÃ©rer et filtrer DATEX II DIR Ouest
      run: |
        python scripts/fetch_datex_diro.py
    
    - name: ğŸ“Š Afficher statistiques
      run: |
        if [ -f data/datex-diro.geojson ]; then
          echo "âœ… Fichier gÃ©nÃ©rÃ© avec succÃ¨s"
          cat data/datex-diro-stats.txt
        else
          echo "âŒ Erreur : fichier non gÃ©nÃ©rÃ©"
          exit 1
        fi
    
    - name: ğŸ’¾ Commit et push des donnÃ©es
      run: |
        git config user.name "DATEX Bot"
        git config user.email "datex-bot@ille-et-vilaine.gouv.fr"
        git add data/datex-diro.geojson data/datex-diro-stats.txt
        git diff --quiet && git diff --staged --quiet || \
          (git commit -m "ğŸ¤– MAJ DATEX DIR Ouest - $(date +'%Y-%m-%d %H:%M')" && git push)
    
    - name: ğŸ“ˆ RÃ©sumÃ©
      if: always()
      run: |
        echo "========================================="
        echo "ğŸ“Š RÃ‰SUMÃ‰ DE L'EXÃ‰CUTION"
        echo "========================================="
        if [ -f data/datex-diro-stats.txt ]; then
          cat data/datex-diro-stats.txt
        fi
        echo "========================================="
